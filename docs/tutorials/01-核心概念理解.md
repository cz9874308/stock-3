# 📚 第1课：核心概念理解

> **⏱️ 预计阅读时间**: 15分钟  
> **🎯 学习目标**: 理解 InStock 的架构设计和数据流程  
> **📊 难度等级**: ⭐⭐ 基础级  
> **📋 前置知识**: 完成 [快速开始](../快速开始.md)

---

## 📋 本课概览

```
┌─────────────────────────────────────────────────────────┐
│                    第1课 学习路线                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│   1.系统架构    2.核心模块    3.数据流程    4.技术栈     │
│   ┌─────┐      ┌─────┐      ┌─────┐      ┌─────┐      │
│   │四层 │ ──▶ │六大 │ ──▶ │五步 │ ──▶ │主要 │      │
│   │架构 │      │模块 │      │流程 │      │依赖 │      │
│   └─────┘      └─────┘      └─────┘      └─────┘      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 1️⃣ 系统架构：四层设计

InStock 采用经典的**分层架构**，就像一栋四层楼：

```
┌─────────────────────────────────────────────────────────────────┐
│                         🏢 InStock 架构大厦                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  4F  ┌───────────────────────────────────────────────────────┐  │
│      │              🖥️ 展示层 (Presentation)                  │  │
│      │                                                       │  │
│      │   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │  │
│      │   │  电脑   │ │  平板   │ │  手机   │ │  API    │   │  │
│      │   └─────────┘ └─────────┘ └─────────┘ └─────────┘   │  │
│      │                    ↑ HTTP :9988                       │  │
│      └───────────────────────────────────────────────────────┘  │
│                              │                                   │
│  3F  ┌───────────────────────┼───────────────────────────────┐  │
│      │              🧠 业务层 (Business)                       │  │
│      │                       │                               │  │
│      │   ┌──────────┐ ┌──────────┐ ┌──────────┐             │  │
│      │   │ 指标计算 │ │ 形态识别 │ │ 策略选股 │             │  │
│      │   └──────────┘ └──────────┘ └──────────┘             │  │
│      │   ┌──────────┐ ┌──────────┐ ┌──────────┐             │  │
│      │   │ 回测验证 │ │ 筹码分布 │ │ 自动交易 │             │  │
│      │   └──────────┘ └──────────┘ └──────────┘             │  │
│      └───────────────────────────────────────────────────────┘  │
│                              │                                   │
│  2F  ┌───────────────────────┼───────────────────────────────┐  │
│      │              🔌 数据层 (Data Access)                    │  │
│      │                       │                               │  │
│      │              ┌────────────────┐                       │  │
│      │              │ stockfetch.py  │ ← 统一数据获取接口     │  │
│      │              └────────────────┘                       │  │
│      │        ┌──────────┼──────────┼──────────┐             │  │
│      │        ↓          ↓          ↓          ↓             │  │
│      │   ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐        │  │
│      │   │ 东方财富│ │  新浪  │ │ 同花顺 │ │ 其他源 │        │  │
│      │   └────────┘ └────────┘ └────────┘ └────────┘        │  │
│      └───────────────────────────────────────────────────────┘  │
│                              │                                   │
│  1F  ┌───────────────────────┼───────────────────────────────┐  │
│      │              💾 存储层 (Storage)                        │  │
│      │                       │                               │  │
│      │              ┌────────────────┐                       │  │
│      │              │ MySQL/MariaDB  │                       │  │
│      │              └────────────────┘                       │  │
│      │   ┌──────────┐ ┌──────────┐ ┌──────────┐             │  │
│      │   │ 股票数据 │ │ 指标数据 │ │ 策略结果 │             │  │
│      │   └──────────┘ └──────────┘ └──────────┘             │  │
│      └───────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 🤔 为什么要分层？

| 层级 | 职责 | 好处 |
|------|------|------|
| 展示层 | 数据可视化、用户交互 | 前端修改不影响后端 |
| 业务层 | 核心计算逻辑 | 业务规则集中管理 |
| 数据层 | 获取外部数据 | 数据源可随时更换 |
| 存储层 | 持久化保存 | 数据独立于程序 |

> 💡 **通俗理解**: 就像餐厅分工——服务员(展示层)负责接待，厨师(业务层)负责做菜，采购员(数据层)负责买菜，冰箱(存储层)负责保存。

---

## 2️⃣ 核心模块：六大金刚

### 模块全景图

```
┌─────────────────────────────────────────────────────────────────┐
│                      📦 InStock 核心模块                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────┐    ┌───────────┐    ┌───────────┐               │
│  │    📥     │    │    📊     │    │    🔍     │               │
│  │  数据采集  │───▶│  指标计算  │───▶│  形态识别  │               │
│  │ crawling  │    │ indicator │    │  pattern  │               │
│  └───────────┘    └───────────┘    └───────────┘               │
│        │                                   │                     │
│        │         ┌───────────┐            │                     │
│        │         │    🎯     │            │                     │
│        └────────▶│  策略选股  │◀───────────┘                     │
│                  │ strategy  │                                  │
│                  └─────┬─────┘                                  │
│                        │                                        │
│        ┌───────────────┴───────────────┐                        │
│        ↓                               ↓                        │
│  ┌───────────┐                  ┌───────────┐                   │
│  │    ✅     │                  │    🤖     │                   │
│  │  回测验证  │                  │  自动交易  │                   │
│  │ backtest  │                  │   trade   │                   │
│  └───────────┘                  └───────────┘                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 模块功能详解

#### 📥 数据采集模块 (`instock/core/crawling/`)

**作用**: 从互联网获取股票原始数据

```
采集的数据类型:
├── 📈 每日行情数据 (开盘价、收盘价、最高价、最低价、成交量)
├── 💰 资金流向数据 (主力、散户买卖情况)
├── 🏆 龙虎榜数据 (游资、机构动向)
├── 📋 基本面数据 (市盈率、市净率、ROE)
└── 📰 ETF 数据
```

#### 📊 指标计算模块 (`instock/core/indicator/`)

**作用**: 计算 32 种技术指标

```python
# 支持的指标示例
MACD  - 异同移动平均线 (判断趋势)
KDJ   - 随机指标 (判断超买超卖)
BOLL  - 布林带 (判断波动区间)
RSI   - 相对强弱指标 (判断超买超卖)
# ... 还有 28 种
```

#### 🔍 形态识别模块 (`instock/core/pattern/`)

**作用**: 识别 61 种 K 线形态

```
识别的形态类型:
├── 🔴 看跌形态: 两只乌鸦、乌云盖顶、暮星...
├── 🟢 看涨形态: 锤头、晨星、三白兵...
└── ⚪ 中性形态: 十字星、纺锤...
```

#### 🎯 策略选股模块 (`instock/core/strategy/`)

**作用**: 根据预设规则筛选股票

| 策略名称 | 核心逻辑 | 适用场景 |
|----------|----------|----------|
| 放量上涨 | 成交量突然放大 + 价格上涨 | 寻找启动信号 |
| 海龟交易 | 突破 N 日最高价 | 趋势跟踪 |
| 停机坪 | 涨停后横盘整理 | 寻找二波机会 |
| 回踩年线 | 回调到 250 日均线 | 中线布局 |

#### ✅ 回测验证模块 (`instock/core/backtest/`)

**作用**: 验证策略的历史表现

```
回测流程:
选股日期 ──▶ 持有 N 天 ──▶ 计算收益率 ──▶ 统计胜率

验证周期: 1日、3日、5日、10日、20日... 最长100日
```

#### 🤖 自动交易模块 (`instock/trade/`)

**作用**: 连接券商客户端执行交易

> ⚠️ **提醒**: 自动交易涉及真金白银，请谨慎使用！

---

## 3️⃣ 数据流程：五步走

### 数据从哪来？到哪去？

```
┌─────────────────────────────────────────────────────────────────┐
│                        📊 数据流转全景                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   STEP 1: 数据采集                                              │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                                                         │   │
│   │   东方财富 ─┐                                           │   │
│   │   新浪财经 ─┼──▶ stockfetch.py ──▶ 原始数据             │   │
│   │   同花顺   ─┘                                           │   │
│   │                                                         │   │
│   └─────────────────────────────────────────────────────────┘   │
│                           ↓                                      │
│   STEP 2: 数据存储                                              │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                                                         │   │
│   │   原始数据 ──▶ MySQL 数据库 ──▶ 持久化保存              │   │
│   │                                                         │   │
│   │   表名示例: cn_stock_spot_buy (每日行情)                │   │
│   │             cn_stock_fund_flow (资金流向)               │   │
│   │                                                         │   │
│   └─────────────────────────────────────────────────────────┘   │
│                           ↓                                      │
│   STEP 3: 数据处理                                              │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                                                         │   │
│   │   ┌────────────┐  ┌────────────┐  ┌────────────┐       │   │
│   │   │  计算指标  │  │  识别形态  │  │  执行策略  │       │   │
│   │   │ MACD/KDJ  │  │  锤头/晨星 │  │  放量上涨  │       │   │
│   │   └────────────┘  └────────────┘  └────────────┘       │   │
│   │                                                         │   │
│   └─────────────────────────────────────────────────────────┘   │
│                           ↓                                      │
│   STEP 4: 回测验证                                              │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                                                         │   │
│   │   策略选出的股票 ──▶ 计算 N 日后收益 ──▶ 统计胜率       │   │
│   │                                                         │   │
│   │   例: 放量上涨策略 → 5日胜率 65% → 值得使用!            │   │
│   │                                                         │   │
│   └─────────────────────────────────────────────────────────┘   │
│                           ↓                                      │
│   STEP 5: 结果展示                                              │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                                                         │   │
│   │   Tornado Web Server (:9988)                            │   │
│   │         ↓                                               │   │
│   │   ┌─────────┐  ┌─────────┐  ┌─────────┐               │   │
│   │   │   PC    │  │  平板   │  │  手机   │               │   │
│   │   └─────────┘  └─────────┘  └─────────┘               │   │
│   │                                                         │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 🕐 数据更新时机

```
┌───────────────────────────────────────────────────────────────┐
│                     📅 数据更新时间表                          │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│   09:30 ──────────── 开盘 ────────────────────────────────    │
│      │                                                        │
│      │   每30分钟: 实时行情数据 (basic_data_daily_job.py)     │
│      │                                                        │
│   15:00 ──────────── 收盘 ────────────────────────────────    │
│      │                                                        │
│      │   收盘后: 指标计算、形态识别、策略选股                   │
│      │                                                        │
│   17:30 ──────────── 完整作业 ────────────────────────────    │
│      │                                                        │
│      │   execute_daily_job.py (全量数据处理)                  │
│      │                                                        │
│   18:00+ ─────────── 延迟数据 ────────────────────────────    │
│                                                               │
│          大宗交易等数据 (收盘后1-2小时才有)                    │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

---

## 4️⃣ 技术栈：主要依赖

### 技术选型一览

```
┌─────────────────────────────────────────────────────────────────┐
│                        🛠️ 技术栈全景                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   🐍 Python 3.11                                                │
│   └── 主语言，简洁高效                                           │
│                                                                 │
│   💾 MySQL / MariaDB                                            │
│   └── 数据存储，支持历史数据查询                                  │
│                                                                 │
│   📊 核心库                                                      │
│   ├── pandas     - 数据处理利器                                  │
│   ├── numpy      - 数值计算基础                                  │
│   ├── TA-Lib     - 技术指标计算                                  │
│   └── SQLAlchemy - 数据库 ORM                                   │
│                                                                 │
│   🌐 Web 框架                                                    │
│   ├── Tornado    - 异步 Web 服务器                               │
│   ├── Bokeh      - 交互式图表                                    │
│   └── SpreadJS   - 表格组件                                      │
│                                                                 │
│   🤖 交易相关                                                    │
│   └── easytrader - 同花顺交易接口                                │
│                                                                 │
│   🐳 部署                                                        │
│   ├── Docker     - 容器化部署                                    │
│   └── Supervisor - 进程管理                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 为什么选这些技术？

| 技术 | 选择原因 |
|------|----------|
| Python | 量化领域主流语言，生态丰富 |
| MySQL | 稳定可靠，适合存储结构化数据 |
| TA-Lib | C 语言实现，计算速度快 |
| Tornado | 支持异步，能处理大量并发请求 |
| Docker | 一键部署，跨平台无忧 |

---

## 🎯 实践任务

完成以下任务来巩固理解：

### 任务1：探索项目目录结构

```bash
# 打开项目根目录，观察文件组织
instock/
├── core/      # 在这里找核心业务代码
├── job/       # 在这里找定时任务
├── web/       # 在这里找 Web 服务代码
└── trade/     # 在这里找交易相关代码
```

**🎯 目标**: 找到 `stockfetch.py` 文件，它在哪个目录下？

<details>
<summary>查看答案</summary>

`instock/core/stockfetch.py`

这是数据获取的统一接口文件。

</details>

### 任务2：查看数据库表结构

```bash
# 连接数据库，查看已创建的表
mysql -u root -p
USE instockdb;
SHOW TABLES;
```

**🎯 目标**: 找到存储每日行情数据的表名

<details>
<summary>查看答案</summary>

表名类似 `cn_stock_spot_YYYYMMDD`，每天一个表。

</details>

### 任务3：理解数据流

画出你理解的数据流程图（用纸笔或任何工具）

**🎯 目标**: 能够解释数据从网站到浏览器展示的完整过程

---

## 🎓 知识检查

### 选择题

**1. InStock 采用几层架构？**
- A) 2层
- B) 3层
- C) 4层
- D) 5层

<details>
<summary>查看答案</summary>

**C) 4层**

分别是：展示层、业务层、数据层、存储层

</details>

**2. 哪个模块负责计算 MACD 指标？**
- A) crawling
- B) indicator
- C) pattern
- D) strategy

<details>
<summary>查看答案</summary>

**B) indicator**

`instock/core/indicator/` 负责所有技术指标的计算

</details>

**3. 默认的 Web 服务端口是？**
- A) 8080
- B) 9988
- C) 3306
- D) 80

<details>
<summary>查看答案</summary>

**B) 9988**

可以在浏览器通过 `http://localhost:9988/` 访问

</details>

---

## 📖 本课小结

```
┌─────────────────────────────────────────────────────────────────┐
│                        📝 第1课 小结                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ✅ InStock 采用四层架构: 展示→业务→数据→存储                   │
│                                                                 │
│   ✅ 六大核心模块: 采集、指标、形态、策略、回测、交易             │
│                                                                 │
│   ✅ 数据流程五步走: 采集→存储→处理→验证→展示                   │
│                                                                 │
│   ✅ 技术栈: Python + MySQL + TA-Lib + Tornado                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📚 下一课预告

**[第2课：数据采集详解](./02-数据采集详解.md)**

你将学习：
- 📥 数据来源有哪些？
- 🔧 如何配置数据抓取？
- 📊 各类数据的含义是什么？
- 🚀 如何扩展新的数据源？

---

> 💡 **学习建议**: 理解架构是基础，后续学习会更轻松！

**有问题？欢迎在 GitHub 提 Issue！** 🙋
