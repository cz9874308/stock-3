# 📥 第2课：数据采集详解

> **⏱️ 预计阅读时间**: 20分钟  
> **🎯 学习目标**: 掌握 InStock 的数据来源和采集方法  
> **📊 难度等级**: ⭐⭐ 基础级  
> **📋 前置知识**: 完成 [第1课：核心概念理解](./01-核心概念理解.md)

---

## 📋 本课概览

```
┌─────────────────────────────────────────────────────────────────┐
│                     第2课 学习路线                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1.数据来源    2.数据类型    3.采集配置    4.扩展开发          │
│   ┌─────┐      ┌─────┐      ┌─────┐      ┌─────┐             │
│   │三大 │ ──▶ │六类 │ ──▶ │代理 │ ──▶ │自定 │             │
│   │数据源│      │数据 │      │Cookie│      │爬虫 │             │
│   └─────┘      └─────┘      └─────┘      └─────┘             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 1️⃣ 数据来源：三大数据源

### 数据源概览

```
┌─────────────────────────────────────────────────────────────────┐
│                     📡 InStock 数据来源                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│           ┌───────────────┐                                     │
│           │  stockfetch   │ ← 统一数据获取接口                   │
│           │    .py        │                                     │
│           └───────┬───────┘                                     │
│                   │                                             │
│       ┌───────────┼───────────┬───────────┐                    │
│       │           │           │           │                     │
│       ↓           ↓           ↓           ↓                     │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐              │
│  │ 🔶 东方 │ │ 🔷 新浪 │ │ 🔶 同花顺│ │ ⬜ 其他 │              │
│  │   财富  │ │  财经   │ │        │ │  数据源 │              │
│  │EastMoney│ │  Sina   │ │  THS   │ │  ....  │              │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘              │
│                                                                 │
│  主要数据源     备用数据源    交易接口     可扩展                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 各数据源特点

| 数据源 | 优点 | 缺点 | 主要用途 |
|--------|------|------|----------|
| 🔶 东方财富 | 数据全、更新快 | 高频访问会被限制 | 主要数据来源 |
| 🔷 新浪财经 | 稳定、限制少 | 部分数据有延迟 | 备用数据源 |
| 🔶 同花顺 | 数据质量高 | 需要配置 Cookie | 特定数据补充 |

### 为什么需要多个数据源？

```
┌─────────────────────────────────────────────────────────────────┐
│                   🔄 多数据源策略                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   场景1: 主数据源被限制                                          │
│   ┌──────────┐         ┌──────────┐                            │
│   │ 东方财富 │ ──X──▶ │  新浪    │ ✓                           │
│   │ 被封 IP  │         │ 自动切换 │                            │
│   └──────────┘         └──────────┘                            │
│                                                                 │
│   场景2: 数据交叉验证                                            │
│   ┌──────────┐         ┌──────────┐                            │
│   │ 东方财富 │ ──比对── │  新浪    │                            │
│   │ 价格: 10 │         │ 价格: 10 │ → 数据可信 ✓               │
│   └──────────┘         └──────────┘                            │
│                                                                 │
│   场景3: 数据互补                                                │
│   ┌──────────┐         ┌──────────┐                            │
│   │ 东方财富 │         │  同花顺  │                            │
│   │ 龙虎榜   │ + ───── │ 分时数据 │ → 信息更全                  │
│   └──────────┘         └──────────┘                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2️⃣ 数据类型：六大类数据

### 数据分类全景

```
┌─────────────────────────────────────────────────────────────────┐
│                      📊 InStock 采集的数据类型                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  📈 1. 每日行情数据                       │   │
│  │  ├── 开盘价 (open)                                       │   │
│  │  ├── 收盘价 (close)                                      │   │
│  │  ├── 最高价 (high)                                       │   │
│  │  ├── 最低价 (low)                                        │   │
│  │  ├── 成交量 (volume)                                     │   │
│  │  └── 成交额 (amount)                                     │   │
│  │  📁 文件: stock_spot_em.py                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  💰 2. 资金流向数据                       │   │
│  │  ├── 主力净流入                                          │   │
│  │  ├── 超大单净流入                                        │   │
│  │  ├── 大单净流入                                          │   │
│  │  ├── 中单净流入                                          │   │
│  │  └── 小单净流入                                          │   │
│  │  📁 文件: stock_fund_em.py                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  🏆 3. 龙虎榜数据                         │   │
│  │  ├── 上榜原因                                            │   │
│  │  ├── 买入金额                                            │   │
│  │  ├── 卖出金额                                            │   │
│  │  ├── 净买入额                                            │   │
│  │  └── 上榜营业部                                          │   │
│  │  📁 文件: stock_lhb_em.py                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  📋 4. 基本面数据                         │   │
│  │  ├── 市盈率 (PE)                                         │   │
│  │  ├── 市净率 (PB)                                         │   │
│  │  ├── 净资产收益率 (ROE)                                  │   │
│  │  ├── 每股收益 (EPS)                                      │   │
│  │  └── 总市值/流通市值                                     │   │
│  │  📁 文件: stock_basic_em.py                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  📰 5. ETF 数据                           │   │
│  │  ├── ETF 行情数据                                        │   │
│  │  ├── 折溢价率                                            │   │
│  │  └── 持仓变动                                            │   │
│  │  📁 文件: stock_etf_em.py                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  🔔 6. 特色数据                           │   │
│  │  ├── 大宗交易                                            │   │
│  │  ├── 分红配送                                            │   │
│  │  ├── 早盘/尾盘抢筹                                       │   │
│  │  └── 涨停原因                                            │   │
│  │  📁 文件: stock_dzjy_em.py 等                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 数据获取时机

```
┌─────────────────────────────────────────────────────────────────┐
│                   ⏰ 数据更新时间线                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   09:30                                                         │
│   │ 开盘                                                        │
│   │ ┌─────────────────────────────────────────────────────┐    │
│   │ │ 🟢 实时可获取:                                       │    │
│   │ │    • 每日行情数据                                    │    │
│   │ │    • 资金流向数据                                    │    │
│   │ │    • ETF 数据                                        │    │
│   │ └─────────────────────────────────────────────────────┘    │
│   │                                                             │
│   │   交易时段 (每30分钟更新一次)                               │
│   │                                                             │
│   15:00                                                         │
│   │ 收盘                                                        │
│   │ ┌─────────────────────────────────────────────────────┐    │
│   │ │ 🟡 收盘后可获取:                                     │    │
│   │ │    • 完整日行情数据                                  │    │
│   │ │    • 龙虎榜数据                                      │    │
│   │ │    • 涨停原因                                        │    │
│   │ └─────────────────────────────────────────────────────┘    │
│   │                                                             │
│   17:00-18:00                                                   │
│   │ 延迟数据                                                    │
│   │ ┌─────────────────────────────────────────────────────┐    │
│   │ │ 🔴 延迟1-2小时:                                      │    │
│   │ │    • 大宗交易数据                                    │    │
│   │ │    • 部分资金数据                                    │    │
│   │ └─────────────────────────────────────────────────────┘    │
│   ↓                                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3️⃣ 采集配置：代理与 Cookie

### 3.1 为什么需要代理？

```
┌─────────────────────────────────────────────────────────────────┐
│                   🛡️ 代理的作用                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   没有代理:                                                      │
│   ┌──────────┐                     ┌──────────┐                │
│   │  你的IP  │ ═══════════════════ │  数据源  │                │
│   │          │ 频繁请求被封 ✗      │          │                │
│   └──────────┘                     └──────────┘                │
│                                                                 │
│   使用代理:                                                      │
│   ┌──────────┐     ┌──────────┐     ┌──────────┐              │
│   │  你的IP  │ ──▶ │  代理1   │ ──▶ │  数据源  │              │
│   │          │ ──▶ │  代理2   │ ──▶ │          │              │
│   │          │ ──▶ │  代理3   │ ──▶ │          │              │
│   └──────────┘     └──────────┘     └──────────┘              │
│                    轮换使用，降低被封风险 ✓                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 配置代理

**文件位置**: `instock/config/proxy.txt`

```bash
# 代理格式示例 (每行一个)

# 格式1: IP:端口
127.0.0.1:7860
52.13.248.29:3128

# 格式2: 带认证的代理
username:password@65.1.244.232:3128
```

**配置步骤**:

```
┌─────────────────────────────────────────────────────────────────┐
│                   📝 代理配置步骤                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Step 1: 获取代理                                              │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ 购买渠道:                                                │   │
│   │   • 阿里云代理                                           │   │
│   │   • 快代理                                               │   │
│   │   • 蘑菇代理                                             │   │
│   │   • 或其他付费代理服务                                   │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Step 2: 编辑配置文件                                          │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ # 打开 instock/config/proxy.txt                         │   │
│   │ # 添加你的代理，每行一个                                  │   │
│   │ 192.168.1.1:8080                                        │   │
│   │ 192.168.1.2:8080                                        │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Step 3: 重启服务生效                                          │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ 修改配置后需要重启 InStock 服务                          │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

> 💡 **提示**: 如果不需要代理，清空 `proxy.txt` 文件即可。

### 3.3 配置 Cookie (东方财富)

**为什么需要 Cookie？**

东方财富对高频访问有限制，注入 Cookie 可以：
- ✅ 突破访问频率限制
- ✅ 获取更完整的数据
- ✅ 提高数据稳定性

**获取 Cookie 步骤**:

```
┌─────────────────────────────────────────────────────────────────┐
│                   🍪 Cookie 获取教程                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Step 1: 打开东方财富行情页面                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ 浏览器访问:                                              │   │
│   │ https://quote.eastmoney.com/center/gridlist.html#hs_a   │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Step 2: 打开开发者工具                                        │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ 快捷键: F12 或 右键 → 检查                               │   │
│   │ 切换到: Network (网络) 选项卡                            │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Step 3: 刷新页面，找到请求                                    │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ 按 F5 刷新页面                                           │   │
│   │ 在请求列表中找包含 push2.eastmoney.com 的请求            │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Step 4: 复制 Cookie                                           │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ 点击该请求 → Headers → Request Headers                   │   │
│   │ 找到 Cookie 字段 → 复制完整值                            │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Step 5: 配置 Cookie                                           │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ 方式一: 环境变量 (推荐)                                  │   │
│   │   setx EAST_MONEY_COOKIE "你的Cookie值"                 │   │
│   │                                                         │   │
│   │ 方式二: 配置文件                                        │   │
│   │   编辑 instock/config/eastmoney_cookie.txt              │   │
│   │   粘贴你的 Cookie 值                                    │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

> ⚠️ **注意**: Cookie 会过期（一般几天到几周），需要定期更新！

---

## 4️⃣ 数据采集命令

### 4.1 完整作业命令

```bash
# 在 instock/job/ 目录下执行

# 1️⃣ 当前日期完整作业
python execute_daily_job.py

# 2️⃣ 指定日期作业
python execute_daily_job.py 2024-01-15

# 3️⃣ 多个日期作业 (逗号分隔)
python execute_daily_job.py 2024-01-15,2024-01-16,2024-01-17

# 4️⃣ 日期范围作业
python execute_daily_job.py 2024-01-01 2024-01-31
```

### 4.2 单模块作业命令

```
┌─────────────────────────────────────────────────────────────────┐
│                   📋 单模块作业命令速查表                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   模块              命令                          说明           │
│   ─────────────────────────────────────────────────────────    │
│   基础数据(实时)    python basic_data_daily_job.py    每日行情  │
│   基础数据(非实时)  python basic_data_other_daily_job.py  其他  │
│   指标计算          python indicators_data_daily_job.py  技术指标│
│   K线形态           python klinepattern_data_daily_job.py 形态  │
│   策略选股          python strategy_data_daily_job.py    策略   │
│   回测验证          python backtest_data_daily_job.py    回测   │
│   综合选股          python selection_data_daily_job.py   综合   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 作业执行流程

```
┌─────────────────────────────────────────────────────────────────┐
│                   🔄 完整作业执行流程                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   execute_daily_job.py 的执行顺序:                              │
│                                                                 │
│   ┌──────────────────┐                                         │
│   │ 1. 基础数据采集  │ ← 从网站抓取原始数据                     │
│   └────────┬─────────┘                                         │
│            ↓                                                    │
│   ┌──────────────────┐                                         │
│   │ 2. 指标数据计算  │ ← 计算 MACD、KDJ 等                      │
│   └────────┬─────────┘                                         │
│            ↓                                                    │
│   ┌──────────────────┐                                         │
│   │ 3. K线形态识别   │ ← 识别锤头、晨星等                       │
│   └────────┬─────────┘                                         │
│            ↓                                                    │
│   ┌──────────────────┐                                         │
│   │ 4. 策略选股执行  │ ← 执行各种选股策略                       │
│   └────────┬─────────┘                                         │
│            ↓                                                    │
│   ┌──────────────────┐                                         │
│   │ 5. 回测数据更新  │ ← 更新历史回测结果                       │
│   └──────────────────┘                                         │
│                                                                 │
│   ⏱️ 总耗时: 约 4 分钟 (普通笔记本)                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5️⃣ 数据存储结构

### 数据库表命名规则

```
┌─────────────────────────────────────────────────────────────────┐
│                   💾 数据库表命名规则                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   格式: cn_{类型}_{内容}_{日期}                                  │
│                                                                 │
│   示例:                                                         │
│   ┌───────────────────────────────────────────────────────┐    │
│   │ cn_stock_spot_20240115                                │    │
│   │ │   │     │    │                                      │    │
│   │ │   │     │    └── 日期: 2024年1月15日                │    │
│   │ │   │     └─────── 内容: 行情数据 (spot)              │    │
│   │ │   └───────────── 类型: 股票 (stock)                 │    │
│   │ └───────────────── 前缀: 中国市场 (cn)                │    │
│   └───────────────────────────────────────────────────────┘    │
│                                                                 │
│   常见表名:                                                      │
│   ├── cn_stock_spot_{date}      每日行情                        │
│   ├── cn_stock_fund_flow_{date} 资金流向                        │
│   ├── cn_stock_indicators_{date}指标数据                        │
│   ├── cn_etf_spot_{date}        ETF 行情                        │
│   └── cn_stock_strategy_{date}  策略结果                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 核心字段说明

```python
# 每日行情数据 (cn_stock_spot) 核心字段

字段名          类型        说明                示例值
─────────────────────────────────────────────────────────
code            VARCHAR     股票代码            "000001"
name            VARCHAR     股票名称            "平安银行"
open            DECIMAL     开盘价              10.50
close           DECIMAL     收盘价              10.80
high            DECIMAL     最高价              10.90
low             DECIMAL     最低价              10.40
volume          BIGINT      成交量(股)          100000000
amount          DECIMAL     成交额(元)          1080000000
pct_chg         DECIMAL     涨跌幅(%)           2.86
amplitude       DECIMAL     振幅(%)             4.76
turnover        DECIMAL     换手率(%)           1.23
```

---

## 6️⃣ 扩展开发：添加新数据源

### 6.1 爬虫文件结构

```python
# 文件位置: instock/core/crawling/your_new_source.py

"""
新数据源爬虫模块

用于从 XXX 网站获取 YYY 数据
"""

import pandas as pd
import requests

def fetch_data(date: str = None) -> pd.DataFrame:
    """
    获取数据的主函数
    
    Args:
        date: 日期字符串，格式 YYYY-MM-DD
        
    Returns:
        包含数据的 DataFrame
    """
    # 1. 构建请求 URL
    url = "https://api.example.com/data"
    
    # 2. 发送请求
    response = requests.get(url)
    
    # 3. 解析数据
    data = response.json()
    
    # 4. 转换为 DataFrame
    df = pd.DataFrame(data)
    
    return df
```

### 6.2 扩展步骤

```
┌─────────────────────────────────────────────────────────────────┐
│                   🔧 添加新数据源步骤                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Step 1: 分析目标网站                                          │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ • 打开开发者工具，分析网络请求                           │   │
│   │ • 找到数据接口 URL                                       │   │
│   │ • 分析请求参数和响应格式                                 │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Step 2: 编写爬虫代码                                          │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ • 在 instock/core/crawling/ 创建新文件                   │   │
│   │ • 实现 fetch_data() 函数                                 │   │
│   │ • 返回标准 DataFrame 格式                                │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Step 3: 注册到 stockfetch.py                                  │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ • 在 stockfetch.py 中导入新模块                          │   │
│   │ • 添加调用入口                                           │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Step 4: 创建数据库表                                          │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ • 在 tablestructure.py 定义表结构                        │   │
│   │ • 系统会自动创建表                                       │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Step 5: 添加定时任务                                          │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ • 在 job/ 目录创建作业脚本                               │   │
│   │ • 配置执行时间                                           │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 实践任务

### 任务1：运行基础数据采集

```bash
cd instock/job
python basic_data_daily_job.py
```

**🎯 目标**: 观察控制台输出，理解采集过程

### 任务2：查看采集的数据

```sql
-- 连接数据库后执行
USE instockdb;

-- 查看今日行情数据
SELECT code, name, close, pct_chg 
FROM cn_stock_spot_买入_YYYYMMDD  -- 替换为实际日期
LIMIT 10;
```

**🎯 目标**: 能够查询到采集的股票数据

### 任务3：配置 Cookie (可选)

按照本课教程，获取东方财富 Cookie 并配置

**🎯 目标**: 体验 Cookie 配置流程

---

## 🎓 知识检查

**1. InStock 的主要数据源是哪个？**
- A) 新浪财经
- B) 东方财富
- C) 同花顺
- D) 腾讯财经

<details>
<summary>查看答案</summary>

**B) 东方财富**

东方财富是主要数据源，数据最全面。

</details>

**2. 为什么需要配置代理？**
- A) 加快访问速度
- B) 避免 IP 被封
- C) 获取更多数据
- D) 以上都对

<details>
<summary>查看答案</summary>

**B) 避免 IP 被封**

代理的主要作用是分散请求来源，避免单一 IP 被封禁。

</details>

**3. 大宗交易数据什么时候能获取？**
- A) 开盘时
- B) 收盘时
- C) 收盘后 1-2 小时
- D) 第二天

<details>
<summary>查看答案</summary>

**C) 收盘后 1-2 小时**

大宗交易数据属于延迟数据，需要等待一段时间才能获取。

</details>

---

## 📖 本课小结

```
┌─────────────────────────────────────────────────────────────────┐
│                        📝 第2课 小结                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ✅ 三大数据源: 东方财富(主) + 新浪(备) + 同花顺(补充)         │
│                                                                 │
│   ✅ 六类数据: 行情、资金、龙虎榜、基本面、ETF、特色数据        │
│                                                                 │
│   ✅ 代理配置: proxy.txt，分散请求避免被封                      │
│                                                                 │
│   ✅ Cookie配置: 突破东方财富访问限制                           │
│                                                                 │
│   ✅ 扩展开发: crawling/ 目录，实现 fetch_data() 函数           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📚 下一课预告

**[第3课：技术分析入门](./03-技术分析入门.md)**

你将学习：
- 📊 什么是技术指标？
- 🔧 如何计算 MACD、KDJ 等？
- 🔍 K 线形态如何识别？
- 📈 如何解读分析结果？

---

> 💡 **学习建议**: 动手实践，运行一次采集作业，观察输出！

**有问题？欢迎在 GitHub 提 Issue！** 🙋
